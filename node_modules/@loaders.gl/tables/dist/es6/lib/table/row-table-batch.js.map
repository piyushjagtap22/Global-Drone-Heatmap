{"version":3,"sources":["../../../../src/lib/table/row-table-batch.js"],"names":["DEFAULT_OPTIONS","batchSize","convertToObject","optimizeMemoryUsage","RowTableBatch","constructor","schema","options","rows","length","isChunkComplete","cursor","Array","isArray","_headers","key","index","name","addRow","row","Number","isFinite","convertRowToObject","JSON","parse","stringify","chunkComplete","isFull","getBatch","slice","data","headers","Error","result","i"],"mappings":"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","sourcesContent":["const DEFAULT_OPTIONS = {\n  batchSize: 'auto',\n  convertToObject: true,\n  // optimizes memory usage but increases parsing time.\n  optimizeMemoryUsage: false\n};\n\nexport default class RowTableBatch {\n  constructor(schema, options = {}) {\n    options = {...DEFAULT_OPTIONS, ...options};\n\n    this.schema = schema;\n    this.batchSize = options.batchSize;\n    this.convertToObject = options.convertToObject;\n    this.optimizeMemoryUsage = options.optimizeMemoryUsage;\n\n    this.rows = null;\n    this.length = 0;\n    this.isChunkComplete = false;\n    this.cursor = 0;\n\n    // schema is an array if there're no headers\n    // object if there are headers\n    if (!Array.isArray(schema)) {\n      this._headers = [];\n      for (const key in schema) {\n        this._headers[schema[key].index] = schema[key].name;\n      }\n    }\n  }\n\n  addRow(row, cursor = null) {\n    if (!this.rows) {\n      this.rows = new Array(this.batchSize);\n      this.length = 0;\n    }\n    if (Number.isFinite(cursor)) {\n      this.cursor = cursor;\n    }\n\n    // We can only convert if we were given a schema\n    const convertToObject = this.convertToObject && this.schema;\n    this.rows[this.length] = convertToObject ? convertRowToObject(row, this._headers) : row;\n\n    if (this.optimizeMemoryUsage) {\n      // A workaround to allocate new strings and don't retain pointers to original strings.\n      // https://bugs.chromium.org/p/v8/issues/detail?id=2869\n      this.rows[this.length] = JSON.parse(JSON.stringify(this.rows[this.length]));\n    }\n\n    this.length++;\n  }\n\n  chunkComplete() {\n    this.isChunkComplete = true;\n  }\n\n  isFull() {\n    if (this.batchSize === 'auto') {\n      return this.isChunkComplete && this.length > 0;\n    }\n    return this.rows && this.length >= this.batchSize;\n  }\n\n  getBatch() {\n    if (this.rows) {\n      const rows = this.rows.slice(0, this.length);\n      this.rows = null;\n      this.isChunkComplete = false;\n      return {data: rows, schema: this.schema, length: rows.length, cursor: this.cursor};\n    }\n    return null;\n  }\n}\n\nfunction convertRowToObject(row, headers) {\n  if (!row) {\n    throw new Error('null row');\n  }\n  if (!Array.isArray(row)) {\n    return row;\n  }\n\n  if (!headers) {\n    return row;\n  }\n  const result = {};\n  for (let i = 0; i < headers.length; i++) {\n    result[headers[i]] = row[i];\n  }\n  return result;\n}\n"],"file":"row-table-batch.js"}